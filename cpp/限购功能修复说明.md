# 限购功能修复说明

## 问题描述
测试过程中发现限购商品仍然可以购买超过限额。

## 问题原因分析

### 1. 购物车添加时未检查限购
- 用户可以无限制地将限购商品添加到购物车
- 只有在结算订单时才检查限购，但此时购物车已经累积了超额数量

### 2. 购物车更新数量时未检查限购
- 用户可以直接在购物车中修改商品数量，绕过限购检查

## 修复方案

### 修复内容

#### 1. CartService.cpp - addToCart方法
**位置**: `cpp/services/CartService.cpp` 第84-144行

**修复**: 在添加商品到购物车时增加限购检查

```cpp
// ========== 检查商品限购规则 ==========
// 获取购物车中该商品的现有数量
int cart_quantity = 0;
if (isCartItemExists(user_id, product_id)) {
    // 查询购物车现有数量
    cart_quantity = ...;
}

// 总需求数量 = 购物车现有数量 + 本次添加数量
int total_requested = cart_quantity + quantity;

// 调用存储过程检查限购
CALL check_user_purchase_limit(user_id, product_id, total_requested, ...)

// 如果超出限购，返回错误信息
```

**效果**: 
- 用户添加商品到购物车时立即检查限购
- 提示用户当前已购买数量、购物车数量和限购规则
- 阻止超出限购的添加操作

#### 2. CartService.cpp - updateCartItemQuantity方法
**位置**: `cpp/services/CartService.cpp` 第266-336行

**修复**: 在更新购物车数量时增加限购检查

```cpp
// 检查商品库存和限购
// 1. 检查商品是否存在且状态正常
// 2. 检查库存是否充足
// 3. 调用存储过程检查限购
CALL check_user_purchase_limit(user_id, product_id, new_quantity, ...)

// 如果超出限购，返回错误信息
```

**效果**:
- 用户修改购物车商品数量时立即检查限购
- 防止通过修改数量绕过限购限制

## 限购检查逻辑

### 存储过程: check_user_purchase_limit

**输入参数**:
- `p_user_id`: 用户ID
- `p_product_id`: 商品ID  
- `p_quantity`: 请求购买数量

**输出参数**:
- `can_purchase`: 是否可以购买 (BOOLEAN)
- `purchased_count`: 已购买数量 (INT)
- `limit_count`: 限购数量 (INT)
- `limit_period`: 限购周期 (VARCHAR)

**检查逻辑**:
1. 从`products`表读取商品的`purchase_limit`和`purchase_limit_period`
2. 如果`purchase_limit = 0`，表示不限购，直接返回可以购买
3. 根据`purchase_limit_period`确定统计周期:
   - `daily`: 今日00:00:00开始
   - `weekly`: 本周一00:00:00开始
   - `monthly`: 本月1日00:00:00开始
   - `total`: 历史全部时间
4. 从`user_purchase_records`表统计用户在周期内的购买数量
5. 判断: `已购买数量 + 请求数量 <= 限购数量`

## 编译和部署

### 1. 重新编译C++ JNI库

**Windows (MinGW)**:
```bash
cd cpp
.\build_oop_jni.bat
```

**Linux/Mac**:
```bash
cd cpp
g++ -std=c++11 -shared -fPIC \
    -I$JAVA_HOME/include -I$JAVA_HOME/include/linux \
    -L/usr/lib/mysql -lmysqlclient \
    -o bin/emshop_native_impl_oop.so \
    emshop_native_impl_oop.cpp \
    services/*.cpp
```

### 2. 重启Java服务器

```bash
cd java
mvn clean package
java -jar target/emshop-server.jar
```

### 3. 测试限购功能

#### 测试场景1: 添加商品到购物车
1. 设置某商品限购2件/总计
2. 用户第一次添加2件商品到购物车 - **应该成功**
3. 用户尝试再添加1件到购物车 - **应该失败**，提示"已有2件，再添加1件将超出限购"

#### 测试场景2: 修改购物车数量
1. 设置某商品限购3件/总计
2. 用户添加2件商品到购物车 - **应该成功**
3. 用户尝试将数量修改为4件 - **应该失败**，提示"限购3件，修改为4件将超出限购"

#### 测试场景3: 跨周期限购
1. 设置某商品限购1件/每日
2. 用户今天购买1件 - **应该成功**
3. 用户今天再次购买 - **应该失败**，提示"今日已购买1件，限购1件/今日"
4. 第二天用户购买1件 - **应该成功**（新的周期）

## 测试SQL

### 查看商品限购配置
```sql
SELECT product_id, name, purchase_limit, purchase_limit_period, stock_quantity
FROM products 
WHERE purchase_limit > 0;
```

### 查看用户购买记录
```sql
SELECT * FROM user_purchase_records 
WHERE user_id = ? AND product_id = ? 
ORDER BY purchase_time DESC;
```

### 设置测试商品限购
```sql
-- 设置总限购2件
UPDATE products SET purchase_limit = 2, purchase_limit_period = 'total' 
WHERE product_id = 1;

-- 设置每日限购1件
UPDATE products SET purchase_limit = 1, purchase_limit_period = 'daily' 
WHERE product_id = 2;

-- 取消限购
UPDATE products SET purchase_limit = 0 
WHERE product_id = 3;
```

### 手动调用存储过程测试
```sql
-- 检查用户1购买商品1，数量2件
CALL check_user_purchase_limit(1, 1, 2, @can, @purchased, @limit, @period);
SELECT @can AS can_purchase, @purchased AS purchased_count, 
       @limit AS limit_count, @period AS limit_period;
```

## 错误码说明

- **Constants::PURCHASE_LIMIT_EXCEEDED (1007)**: 超出限购数量
- 客户端应该显示友好的错误提示，明确告知用户限购规则

## 相关文件

- `cpp/services/CartService.cpp` - 购物车服务（已修改）
- `cpp/services/OrderService.cpp` - 订单服务（已有限购检查）
- `cpp/add_purchase_limit.sql` - 限购功能数据库脚本
- `cpp/emshop_native_impl_oop.cpp` - JNI主文件

## 注意事项

1. **购买记录表**: `user_purchase_records`必须正确记录每次购买
2. **订单状态**: 订单取消或退款时，购买记录状态应该同步更新为`cancelled`或`refunded`
3. **触发器**: `update_purchase_record_on_refund`触发器确保订单状态变化时更新购买记录
4. **性能**: 限购检查使用了索引`idx_user_product_time_status`，确保查询性能

## 修复日期
2025年10月16日

## 修复人员
GitHub Copilot

---

**测试通过后请删除此文件**
