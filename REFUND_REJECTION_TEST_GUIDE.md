# 退款拒绝限制功能测试指南

**测试日期**: 2025年10月14日  
**功能版本**: v1.1.1  
**测试目的**: 验证用户无法对被拒绝的订单再次申请退款

---

## 📋 测试前准备

### 1. 确认服务器状态
✅ 服务器已启动在端口 8080  
✅ 已加载新版本 DLL (1,578,796 bytes)

### 2. 准备测试数据

需要准备以下订单:
- **订单A**: 从未申请过退款 → 用于测试首次申请
- **订单B**: 退款申请被拒绝 → 用于测试拒绝后限制
- **订单C**: 退款申请待审核 → 用于测试重复申请拦截

---

## 🧪 测试场景

### 场景1: 首次申请退款 ✅

**目标**: 验证正常退款流程不受影响

**步骤**:
1. 登录普通用户账号 (如: `Quxc5524`)
2. 找到一个已支付但未申请退款的订单 (如: 订单#25)
3. 点击"申请退款"按钮
4. 填写退款原因: "商品质量问题"
5. 提交申请

**预期结果**:
```
✅ 申请成功
✅ 订单状态变为 "refunding"
✅ 显示消息: "退款申请已提交，等待管理员审核"
✅ 数据库中创建退款记录
```

**实际日志**:
```
2025-10-14 23:08:10 [INFO] [OrderService] 用户申请退款，订单ID: 25, 用户ID: 9, 原因: 商品质量问题
2025-10-14 23:08:10 [INFO] [OrderService] 退款申请成功: refund_id=XX, order_id=25
```

---

### 场景2: 管理员拒绝退款申请 ✅

**目标**: 准备被拒绝的订单用于后续测试

**步骤**:
1. 登出普通用户
2. 登录管理员账号 (`admin`)
3. 进入订单管理页面
4. 找到场景1中创建的退款申请
5. 点击"拒绝退款"按钮
6. 填写拒绝原因: "商品使用痕迹明显，不符合退款条件"
7. 提交

**预期结果**:
```
✅ 退款申请状态变为 "rejected"
✅ 订单状态恢复为 "paid" 或 "shipped"
✅ 拒绝原因保存到数据库
✅ 用户收到通知
```

**数据库验证**:
```sql
SELECT refund_id, order_id, status, admin_reply 
FROM refund_requests 
WHERE order_id = 25;

-- 预期结果:
-- refund_id | order_id | status   | admin_reply
-- 8         | 25       | rejected | 商品使用痕迹明显，不符合退款条件
```

---

### 场景3: 尝试对被拒绝订单再次申请退款 ⭐ 核心测试

**目标**: 验证被拒绝后无法再次申请

**步骤**:
1. 登出管理员
2. 重新登录普通用户 (`Quxc5524`)
3. 找到刚才被拒绝的订单 (订单#25)
4. 点击"申请退款"按钮
5. 填写退款原因: "再次申请退款"
6. 提交申请

**预期结果**: ❌ 申请失败
```json
{
    "success": false,
    "message": "该订单的退款申请已被管理员拒绝，不能再次申请退款。拒绝原因: 商品使用痕迹明显，不符合退款条件",
    "code": 400
}
```

**前端显示**:
- 弹出错误提示
- 显示完整的拒绝原因
- 无法提交申请

**日志验证**:
```
2025-10-14 XX:XX:XX [INFO] [OrderService] 用户申请退款，订单ID: 25, 用户ID: 9, 原因: 再次申请退款
[不应该有 "退款申请成功" 的日志]
```

---

### 场景4: 重复申请待审核订单 (已有功能)

**目标**: 确认原有的重复申请拦截仍然有效

**步骤**:
1. 找到一个有待审核退款的订单 (订单#26)
2. 尝试再次申请退款

**预期结果**: ❌ 申请失败
```json
{
    "success": false,
    "message": "该订单已有待审核的退款申请",
    "code": 400
}
```

---

### 场景5: 已批准退款的订单

**目标**: 确认已退款订单不能再申请

**步骤**:
1. 找到一个已批准退款的订单 (订单状态: refunded)
2. 尝试申请退款

**预期结果**: ❌ 申请失败
```json
{
    "success": false,
    "message": "订单状态不允许申请退款",
    "code": 400
}
```

---

## 📊 测试检查清单

### 功能测试
- [ ] 首次申请退款成功
- [ ] 管理员可以拒绝退款
- [ ] 拒绝原因正确保存
- [ ] 被拒绝订单无法再次申请
- [ ] 错误消息包含拒绝原因
- [ ] 待审核订单无法重复申请
- [ ] 已退款订单无法再申请

### 数据库测试
- [ ] 退款记录正确插入 `refund_requests` 表
- [ ] `status` 字段正确更新 (pending → rejected)
- [ ] `admin_reply` 字段正确保存
- [ ] 订单状态正确变化

### 日志测试
- [ ] 申请退款日志完整
- [ ] 拒绝退款日志完整
- [ ] 错误信息正确记录

### 安全性测试
- [ ] 用户只能操作自己的订单
- [ ] 管理员权限正确验证
- [ ] SQL注入防护有效

---

## 🐛 错误排查

### 问题1: 提示"无法再次申请"但实际订单没有被拒绝

**检查步骤**:
1. 查询数据库:
```sql
SELECT * FROM refund_requests WHERE order_id = ?;
```
2. 确认是否存在 `status = 'rejected'` 的记录
3. 如果不存在,可能是缓存问题或数据不一致

**解决方案**:
- 重启服务器
- 清理测试数据后重新测试

---

### 问题2: 错误消息没有显示拒绝原因

**检查步骤**:
1. 确认 `admin_reply` 字段有值:
```sql
SELECT admin_reply FROM refund_requests WHERE order_id = ? AND status = 'rejected';
```
2. 检查 C++ 代码中是否正确读取了 `admin_reply`
3. 查看日志中的错误消息完整内容

**可能原因**:
- `admin_reply` 为 NULL
- 字段名错误
- JSON 解析问题

---

### 问题3: 拒绝后仍然可以申请

**检查步骤**:
1. 确认使用的是新版本 DLL:
```
文件大小: 1,578,796 bytes
编译时间: 2025-10-14 23:10
```
2. 检查 DLL 是否正确部署到 `java/target/classes/`
3. 确认服务器重启后加载了新 DLL

**解决方案**:
- 重新编译 C++ 库
- 确保复制到正确位置
- 完全重启服务器 (停止后再启动)

---

## 📈 性能测试

### 响应时间测试

**测试方法**:
- 使用工具记录退款申请的响应时间
- 对比新增检查前后的性能差异

**预期结果**:
- 额外延迟: < 10ms
- 不影响用户体验

### 并发测试

**测试方法**:
- 多个用户同时对不同订单申请退款
- 验证并发安全性

**预期结果**:
- 无数据竞争
- 所有请求正确处理

---

## 🎯 验收标准

### 必须通过 (P0)
✅ 被拒绝订单无法再次申请退款  
✅ 错误消息清晰准确  
✅ 不影响正常退款流程  
✅ 数据库状态一致

### 建议通过 (P1)
✅ 错误消息包含拒绝原因  
✅ 日志记录完整  
✅ 性能影响可接受

### 可选 (P2)
- 前端友好提示
- 客服联系方式
- 申诉渠道

---

## 📝 测试报告模板

### 测试概况
- **测试人员**: ___________
- **测试日期**: 2025年10月14日
- **测试环境**: 开发环境
- **测试版本**: v1.1.1

### 测试结果
| 场景 | 预期结果 | 实际结果 | 状态 |
|------|----------|----------|------|
| 场景1: 首次申请 | 成功 | ______ | ☐ |
| 场景2: 管理员拒绝 | 成功 | ______ | ☐ |
| 场景3: 再次申请被拒订单 | 失败(预期) | ______ | ☐ |
| 场景4: 重复申请待审核 | 失败(预期) | ______ | ☐ |
| 场景5: 已退款订单 | 失败(预期) | ______ | ☐ |

### 问题记录
| 序号 | 问题描述 | 严重程度 | 状态 |
|------|----------|----------|------|
| 1 | _________ | _______ | ____ |

### 结论
- [ ] 通过测试，可以发布
- [ ] 部分通过，需要修复
- [ ] 测试失败，需要重新开发

---

## 🚀 快速测试命令

### 查询被拒绝的订单
```sql
SELECT r.refund_id, r.order_id, o.user_id, r.status, r.admin_reply, r.updated_at
FROM refund_requests r
JOIN orders o ON r.order_id = o.order_id
WHERE r.status = 'rejected'
ORDER BY r.updated_at DESC
LIMIT 10;
```

### 重置测试订单 (清理测试数据)
```sql
-- 警告: 仅用于测试环境!
DELETE FROM refund_requests WHERE order_id = 25;
UPDATE orders SET status = 'paid' WHERE order_id = 25;
```

### 查看实时日志
```bash
# Windows PowerShell
Get-Content java/logs/emshop-info.log -Wait -Tail 50
```

---

## 💡 测试技巧

1. **使用管理员账号和普通用户账号交替测试**
   - 管理员: admin / admin123
   - 普通用户: Quxc5524 / 123456

2. **保留测试数据用于回归测试**
   - 不要删除被拒绝的订单记录
   - 可用于后续功能测试

3. **监控日志文件**
   - 错误日志: `java/logs/emshop-error.log`
   - 业务日志: `java/logs/emshop-business.log`

4. **使用数据库工具验证**
   - 推荐: MySQL Workbench, DBeaver
   - 直接查询数据库确认状态

---

## 📞 支持

如遇到问题,请:
1. 检查日志文件
2. 查看本文档的"错误排查"章节
3. 联系开发团队

---

*测试指南生成时间: 2025-10-14 23:14*  
*对应功能文档: REFUND_REJECTION_LIMIT_2025-10-14.md*
