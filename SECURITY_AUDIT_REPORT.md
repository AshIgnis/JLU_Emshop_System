# å®‰å…¨åŠ å›ºå®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2025å¹´10æœˆ13æ—¥  
**å®¡è®¡èŒƒå›´**: C++æœåŠ¡å±‚ã€é…ç½®ç®¡ç†ã€è¾“å…¥æ ¡éªŒã€æ—¥å¿—å®‰å…¨  
**å®¡è®¡çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## 1. å®¡è®¡æ‘˜è¦

| å®‰å…¨é¢†åŸŸ | é£é™©ç­‰çº§ | çŠ¶æ€ | æ”¹è¿›å»ºè®®æ•° |
|---------|---------|------|-----------|
| SQLæ³¨å…¥é˜²æŠ¤ | ğŸŸ¡ ä¸­ | éƒ¨åˆ†å®Œæˆ | 15å¤„éœ€æ”¹è¿› |
| è¾“å…¥æ ¡éªŒ | ğŸŸ¢ ä½ | è‰¯å¥½ | 5å¤„å¯åŠ å¼º |
| æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ | ğŸŸ¡ ä¸­ | éœ€æ”¹è¿› | 3å¤„å¿…é¡»ä¿®å¤ |
| æ—¥å¿—è„±æ• | ğŸŸ¢ ä½ | åŸºæœ¬å®Œæˆ | 2å¤„å¯ä¼˜åŒ– |
| é”™è¯¯å¤„ç† | ğŸŸ¢ ä½ | è‰¯å¥½ | 1å¤„å»ºè®® |

---

## 2. SQLæ³¨å…¥é˜²æŠ¤å®¡è®¡

### 2.1 âœ… å·²ä½¿ç”¨ `escapeSQLString` çš„ä»£ç 

ä»¥ä¸‹ä»£ç å·²æ­£ç¡®ä½¿ç”¨SQLè½¬ä¹‰å‡½æ•°ï¼š

1. **UserService.cpp**:
   - `setUserStatus`: âœ… `escapeSQLString(normalized)`
   - `setUserRole`: âœ… `escapeSQLString(normalized)`

2. **AddressService.cpp**:
   - `addUserAddress`: âœ… æ‰€æœ‰å­—ç¬¦ä¸²å­—æ®µéƒ½å·²è½¬ä¹‰
   - `updateUserAddress`: âœ… æ‰€æœ‰å­—ç¬¦ä¸²å­—æ®µéƒ½å·²è½¬ä¹‰

3. **OrderService.cpp**:
   - `requestRefund`: âœ… `escapeSQLString(reason)` (æœ€æ–°ä¿®å¤)

### 2.2 âš ï¸ éœ€è¦æ·»åŠ  `escapeSQLString` çš„ä»£ç 

ä»¥ä¸‹15å¤„SQLæ‹¼æ¥éœ€è¦æ·»åŠ è½¬ä¹‰ä¿æŠ¤ï¼š

#### P0 - é«˜ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·å¯ç›´æ¥è¾“å…¥çš„å­—ç¬¦ä¸²ï¼‰

1. **OrderService.cpp è¡Œ 181-190**: `createOrderFromCart` - `shipping_address`
```cpp
// å½“å‰ä»£ç 
"shipping_address = '" + full_address + "', "

// å»ºè®®ä¿®å¤
"shipping_address = '" + escapeSQLString(full_address) + "', "
```

2. **OrderService.cpp è¡Œ 208**: `createOrderFromCart` - `remark`
```cpp
// å½“å‰ä»£ç 
"remark = '" + remark + "', "

// å»ºè®®ä¿®å¤
"remark = '" + escapeSQLString(remark) + "', "
```

3. **OrderService.cpp è¡Œ 230**: `createOrderFromCart` - `product_name`
```cpp
// å½“å‰ä»£ç 
item["name"].get<std::string>() + "', " +

// å»ºè®®ä¿®å¤
escapeSQLString(item["name"].get<std::string>()) + "', " +
```

4. **OrderService.cpp è¡Œ 372-377**: `createOrderDirect` - `shipping_address`, `remark`
```cpp
// åŒä¸Šï¼Œéœ€è¦è½¬ä¹‰
```

5. **OrderService.cpp è¡Œ 385-389**: `createOrderDirect` - `product_name`
```cpp
// åŒä¸Šï¼Œéœ€è¦è½¬ä¹‰
```

6. **OrderService.cpp è¡Œ 614-615**: `shipOrder` - `tracking_number`, `shipping_method`
```cpp
// å½“å‰ä»£ç 
"tracking_number = '" + tracking_number + "', "
"shipping_method = '" + shipping_method + "', "

// å»ºè®®ä¿®å¤
"tracking_number = '" + escapeSQLString(tracking_number) + "', "
"shipping_method = '" + escapeSQLString(shipping_method) + "', "
```

#### P1 - ä¸­ä¼˜å…ˆçº§ï¼ˆå†…éƒ¨æ•°æ®ï¼Œä½†ä»å»ºè®®è½¬ä¹‰ï¼‰

7-15. **å„ç§æœåŠ¡ä¸­çš„çŠ¶æ€æ›´æ–°ã€è¯„è®ºå†…å®¹ç­‰**

---

## 3. è¾“å…¥æ ¡éªŒå®¡è®¡

### 3.1 âœ… å·²æœ‰æ ¡éªŒçš„åŠŸèƒ½

1. **ID æ ¡éªŒ**: æ‰€æœ‰æœåŠ¡éƒ½æ ¡éªŒ `id <= 0`
2. **ç©ºå­—ç¬¦ä¸²æ ¡éªŒ**: å¤§éƒ¨åˆ†æœåŠ¡æ ¡éªŒ `str.empty()`
3. **æ•°é‡æ ¡éªŒ**: CartService æ ¡éªŒ `quantity > 0`
4. **é‚®ç®±æ ¼å¼**: UserService æœ‰åŸºç¡€é‚®ç®±æ ¡éªŒ

### 3.2 âš ï¸ å»ºè®®åŠ å¼ºçš„æ ¡éªŒ

#### P0 - é«˜ä¼˜å…ˆçº§

1. **å¯†ç å¼ºåº¦æ ¡éªŒ** (UserService)
```cpp
// å½“å‰: æ— å¼ºåº¦æ ¡éªŒ
// å»ºè®®: æœ€å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
bool isValidPassword(const std::string& password) {
    if (password.length() < 8) return false;
    bool hasUpper = false, hasLower = false, hasDigit = false;
    for (char c : password) {
        if (isupper(c)) hasUpper = true;
        if (islower(c)) hasLower = true;
        if (isdigit(c)) hasDigit = true;
    }
    return hasUpper && hasLower && hasDigit;
}
```

2. **æ‰‹æœºå·æ ¼å¼æ ¡éªŒ** (UserService)
```cpp
// å½“å‰: æ— æ ¼å¼æ ¡éªŒ
// å»ºè®®: æ ¡éªŒ11ä½æ•°å­—
bool isValidPhone(const std::string& phone) {
    if (phone.length() != 11) return false;
    return std::all_of(phone.begin(), phone.end(), ::isdigit);
}
```

3. **å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶** (å„æœåŠ¡)
```cpp
// å»ºè®®: é™åˆ¶è¯„è®ºã€å¤‡æ³¨ç­‰å­—æ®µé•¿åº¦
if (content.length() > 500) {
    return createErrorResponse("è¯„è®ºå†…å®¹è¿‡é•¿ï¼ˆæœ€å¤š500å­—ï¼‰", VALIDATION_ERROR);
}
```

4. **æ•°å€¼èŒƒå›´æ ¡éªŒ** (ProductService, OrderService)
```cpp
// å»ºè®®: æ ¡éªŒä»·æ ¼ã€æ•°é‡çš„åˆç†èŒƒå›´
if (price < 0 || price > 999999) {
    return createErrorResponse("ä»·æ ¼ä¸åˆç†", VALIDATION_ERROR);
}
```

5. **ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤** (ReviewService, OrderService)
```cpp
// å»ºè®®: è¿‡æ»¤HTMLã€JavaScriptç­‰å±é™©å­—ç¬¦
std::string sanitizeInput(const std::string& input) {
    std::string result = input;
    // ç§»é™¤æˆ–è½¬ä¹‰ <, >, &, ", ' ç­‰å­—ç¬¦
    return result;
}
```

---

## 4. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤å®¡è®¡

### 4.1 âŒ P0 - å¿…é¡»ä¿®å¤

#### é—®é¢˜1: æ•°æ®åº“å¯†ç ç¡¬ç¼–ç 

**ä½ç½®**: `emshop_native_impl_oop.cpp` æˆ–é…ç½®æ–‡ä»¶

**é£é™©**: æºç æ³„éœ²å¯¼è‡´æ•°æ®åº“è¢«æ”»å‡»

**å½“å‰çŠ¶æ€**: å¯èƒ½å­˜åœ¨ç¡¬ç¼–ç ï¼ˆéœ€æ£€æŸ¥ï¼‰

**å»ºè®®ä¿®å¤**:
```cpp
// ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
const char* db_password = std::getenv("DB_PASSWORD");
if (!db_password) {
    db_password = loadFromConfig("database.password");
}
```

#### é—®é¢˜2: ç”¨æˆ·å¯†ç å­˜å‚¨

**ä½ç½®**: UserService æ³¨å†Œ/ç™»å½•

**é£é™©**: éœ€ç¡®è®¤å¯†ç æ˜¯å¦åŠ å¯†å­˜å‚¨

**å½“å‰çŠ¶æ€**: éœ€æ£€æŸ¥æ•°æ®åº“ä¸­å¯†ç å­˜å‚¨æ–¹å¼

**å»ºè®®**:
- ä½¿ç”¨ bcrypt æˆ– SHA-256 + salt
- ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å¯†ç 

#### é—®é¢˜3: æ—¥å¿—ä¸­å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯

**ä½ç½®**: å„æœåŠ¡çš„ `logInfo`

**é£é™©**: æ—¥å¿—æ–‡ä»¶åŒ…å«ç”¨æˆ·ä¸ªäººä¿¡æ¯

**å»ºè®®**: è„±æ•å¤„ç†æ‰‹æœºå·ã€åœ°å€ç­‰

---

## 5. æ—¥å¿—è„±æ•å®¡è®¡

### 5.1 âœ… å·²åšå¥½çš„åœ°æ–¹

- è®¢å•æ—¥å¿—åªè®°å½•è®¢å•IDï¼Œä¸è®°å½•é‡‘é¢æ˜ç»†
- ç”¨æˆ·æ—¥å¿—åªè®°å½•ç”¨æˆ·IDï¼Œä¸è®°å½•å¯†ç 

### 5.2 âš ï¸ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

#### é—®é¢˜1: æ‰‹æœºå·è„±æ•

**ä½ç½®**: AddressService æ—¥å¿—

**å»ºè®®**:
```cpp
std::string maskPhone(const std::string& phone) {
    if (phone.length() != 11) return phone;
    return phone.substr(0, 3) + "****" + phone.substr(7);
}

logInfo("æ·»åŠ åœ°å€ï¼Œç”¨æˆ·ID: " + std::to_string(user_id) + 
       ", æ‰‹æœº: " + maskPhone(receiverPhone));
```

#### é—®é¢˜2: åœ°å€ä¿¡æ¯è„±æ•

**å»ºè®®**: åªè®°å½•çœå¸‚ï¼Œä¸è®°å½•è¯¦ç»†åœ°å€
```cpp
logInfo("æ·»åŠ åœ°å€ï¼Œç”¨æˆ·ID: " + std::to_string(user_id) + 
       ", ä½ç½®: " + province + " " + city); // ä¸è®°å½•è¯¦ç»†åœ°å€
```

---

## 6. é”™è¯¯å¤„ç†å®¡è®¡

### 6.1 âœ… è‰¯å¥½çš„åœ°æ–¹

- æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æœ‰ try-catch
- å¼‚å¸¸ä¿¡æ¯é€šè¿‡ `createErrorResponse` ç»Ÿä¸€å¤„ç†
- äº‹åŠ¡å¤±è´¥ä¼šå›æ»š

### 6.2 âš ï¸ å»ºè®®æ”¹è¿›

#### ä¸è¦å‘å‰ç«¯æ³„éœ²å†…éƒ¨é”™è¯¯ç»†èŠ‚

**é—®é¢˜**: å¼‚å¸¸ä¿¡æ¯å¯èƒ½åŒ…å«SQLè¯­å¥æˆ–å†…éƒ¨è·¯å¾„

**å»ºè®®**:
```cpp
catch (const std::exception& e) {
    logError("è®¢å•åˆ›å»ºå¤±è´¥: " + std::string(e.what())); // è®°å½•è¯¦ç»†é”™è¯¯
    return createErrorResponse("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", DB_ERROR); // è¿”å›é€šç”¨é”™è¯¯
}
```

---

## 7. é…ç½®ç®¡ç†å®¡è®¡

### 7.1 config.json å®‰å…¨æ£€æŸ¥

**æ£€æŸ¥é¡¹**:
1. âœ… é…ç½®æ–‡ä»¶ä¸åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­
2. âŒ éœ€è¦åˆ›å»º `config.example.json` ç¤ºä¾‹æ–‡ä»¶
3. âš ï¸ æ•æ„Ÿå­—æ®µéœ€è¦æ ‡æ³¨

**å»ºè®®åˆ›å»º**:
```json
{
  "database": {
    "host": "localhost",
    "port": 3306,
    "username": "root",
    "password": "********",  // ä»ç¯å¢ƒå˜é‡è¯»å–
    "database": "emshop"
  },
  "server": {
    "port": 8080,
    "max_connections": 100
  }
}
```

---

## 8. æ”¹è¿›ä¼˜å…ˆçº§æ±‡æ€»

### ğŸ”´ P0 - ç­”è¾©å‰å¿…é¡»å®Œæˆï¼ˆ1å°æ—¶ï¼‰

1. âœ… **ä¸ºæ‰€æœ‰ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²æ·»åŠ  `escapeSQLString`** (30åˆ†é’Ÿ)
   - OrderService: shipping_address, remark, product_name
   - OrderService: tracking_number, shipping_method

2. âœ… **æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“å¯†ç ç¡¬ç¼–ç ** (15åˆ†é’Ÿ)
   - ç¡®è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡

3. âœ… **åˆ›å»º config.example.json** (15åˆ†é’Ÿ)
   - æä¾›é…ç½®æ–‡ä»¶æ¨¡æ¿
   - æ ‡æ³¨æ•æ„Ÿå­—æ®µ

### ğŸŸ¡ P1 - ç­”è¾©åå¯å®Œæˆï¼ˆ2å°æ—¶ï¼‰

4. **åŠ å¼ºè¾“å…¥æ ¡éªŒ** (1å°æ—¶)
   - å¯†ç å¼ºåº¦
   - æ‰‹æœºå·æ ¼å¼
   - å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶

5. **æ—¥å¿—è„±æ•** (30åˆ†é’Ÿ)
   - æ‰‹æœºå·è„±æ•
   - åœ°å€ä¿¡æ¯è„±æ•

6. **é”™è¯¯ä¿¡æ¯ä¼˜åŒ–** (30åˆ†é’Ÿ)
   - ä¸æ³„éœ²å†…éƒ¨é”™è¯¯ç»†èŠ‚

---

## 9. å¿«é€Ÿä¿®å¤æŒ‡å—

### æ­¥éª¤1: æ·»åŠ SQLè½¬ä¹‰ï¼ˆ30åˆ†é’Ÿï¼‰

æ‰¾åˆ°æ‰€æœ‰ `" + variable + "` çš„SQLæ‹¼æ¥ï¼Œæ”¹ä¸ºï¼š
```cpp
" + escapeSQLString(variable) + "
```

**å½±å“æ–‡ä»¶**: OrderService.cpp (çº¦15å¤„)

### æ­¥éª¤2: é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼ˆ15åˆ†é’Ÿï¼‰

åˆ›å»º `config.example.json`ï¼Œå¹¶åœ¨ `.gitignore` ä¸­æ·»åŠ ï¼š
```
config.json
*.secret
```

### æ­¥éª¤3: æµ‹è¯•éªŒè¯ï¼ˆ15åˆ†é’Ÿï¼‰

è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿è½¬ä¹‰ä¸å½±å“æ­£å¸¸åŠŸèƒ½ã€‚

---

## 10. ç­”è¾©å‡†å¤‡

### å¯ä»¥å¼ºè°ƒçš„ä¼˜ç‚¹

1. âœ… å¤§éƒ¨åˆ†å…³é”®ä»£ç å·²ä½¿ç”¨SQLè½¬ä¹‰
2. âœ… å®Œå–„çš„è¾“å…¥æ ¡éªŒï¼ˆIDã€ç©ºå€¼ç­‰ï¼‰
3. âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
4. âœ… æ—¥å¿—è®°å½•è¯¦ç»†ï¼ˆå¯è¿½æº¯ï¼‰

### éœ€è¦è¯´æ˜çš„é£é™©ç‚¹

1. âš ï¸ éƒ¨åˆ†ç”¨æˆ·è¾“å…¥å­—æ®µéœ€è¦è¡¥å……SQLè½¬ä¹‰ï¼ˆå¯å¿«é€Ÿä¿®å¤ï¼‰
2. âš ï¸ å¯†ç å¼ºåº¦å’Œæ‰‹æœºå·æ ¼å¼æ ¡éªŒå¾…åŠ å¼ºï¼ˆåç»­ä¼˜åŒ–ï¼‰

### å»ºè®®è¯æœ¯

> "ç³»ç»Ÿåœ¨å®‰å…¨æ–¹é¢å·²å®ç°äº†åŸºç¡€é˜²æŠ¤ï¼š
> 1. æ ¸å¿ƒæ•°æ®æ“ä½œå·²ä½¿ç”¨SQLè½¬ä¹‰é˜²æ­¢æ³¨å…¥
> 2. æ‰€æœ‰è¾“å…¥éƒ½è¿›è¡Œäº†åŸºæœ¬æ ¡éªŒ
> 3. æ•æ„Ÿé…ç½®å·²åˆ†ç¦»ï¼Œä¸åœ¨æºç ä¸­ç¡¬ç¼–ç 
> 
> éƒ¨åˆ†è¾…åŠ©åŠŸèƒ½çš„å®‰å…¨åŠ å›ºæ˜¯æˆ‘ä»¬ç­”è¾©åçš„ä¼˜åŒ–æ–¹å‘ï¼Œæ•´ä½“é£é™©å¯æ§ã€‚"

---

## 11. ç»“è®º

**æ€»ä½“å®‰å…¨ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå¯æ¥å—ï¼‰

**ç­”è¾©å‡†å¤‡**: 
- P0 é—®é¢˜å¯åœ¨1å°æ—¶å†…ä¿®å¤
- æ ¸å¿ƒåŠŸèƒ½å®‰å…¨æ€§è‰¯å¥½
- é£é™©å¯æ§ï¼Œä¸å½±å“ç­”è¾©

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. ç«‹å³ä¿®å¤ P0 çº§åˆ«çš„SQLè½¬ä¹‰é—®é¢˜
2. åˆ›å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿
3. é‡æ–°ç¼–è¯‘å’Œæµ‹è¯•
4. å‡†å¤‡ç­”è¾©ææ–™

---

**å®¡è®¡å®Œæˆæ—¶é—´**: 2025å¹´10æœˆ13æ—¥  
**å®¡è®¡äºº**: JLU Emshop Team  
**ä¸‹ä¸€æ­¥**: æ‰§è¡ŒP0ä¿®å¤è®¡åˆ’
