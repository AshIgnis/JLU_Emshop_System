# JLU Emshop System - 权限系统测试指南

## 系统概述

JLU Emshop System 现在包含完整的权限管理系统，区分管理员和普通用户的不同权限。

### 架构组件

1. **管理员控制台** (`AdminConsole.java`) - 管理员专用界面
2. **用户购物界面** (`UserConsole.java`) - 普通用户购物界面  
3. **Netty服务器** (`EmshopNettyServer.java`) - 后端服务器，包含权限验证
4. **权限服务** (`PermissionService.java`) - 权限管理中心
5. **JNI接口** (`EmshopNativeInterface.java`) - 与C++后端通信

## 启动步骤

### 1. 启动服务器
```bash
cd d:\codehome\jlu\JLU_Emshop_System\java
mvn exec:java@server
```

### 2. 启动管理员控制台
```bash
# 新终端
cd d:\codehome\jlu\JLU_Emshop_System\java  
mvn exec:java@admin
```

### 3. 启动用户购物界面
```bash
# 新终端
cd d:\codehome\jlu\JLU_Emshop_System\java
mvn exec:java@user
```

### 4. 启动网络客户端 (用于测试)
```bash
# 新终端
cd d:\codehome\jlu\JLU_Emshop_System\java
mvn exec:java@client
```

## 测试账户

数据库中已有的测试账户：

| 用户名 | 密码 | 角色 | 描述 |
|--------|------|------|------|
| admin | 123456 | admin | 管理员账户，拥有所有权限 |
| testuser | password | user | 普通用户，只有购物权限 |

## 权限测试场景

### 场景1：管理员权限测试

1. **管理员登录**
   - 使用管理员控制台登录 (admin/123456)
   - 应该能够成功登录并看到管理菜单

2. **库存管理测试** (仅管理员)
   - 查看库存: 应该显示所有产品库存
   - 更新库存: 应该能够修改产品库存数量
   - 低库存报告: 应该显示库存不足的产品

3. **商品管理测试** (仅管理员)
   - 添加商品: 管理员控制台应该提供商品添加功能
   - 编辑商品: 应该能够修改商品信息
   - 删除商品: 应该能够删除商品

### 场景2：普通用户权限测试

1. **用户登录**
   - 使用用户界面登录 (testuser/password)
   - 应该能够成功登录并看到购物菜单

2. **购物功能测试** (用户权限)
   - 浏览商品: 应该能够查看商品列表
   - 添加到购物车: 应该能够将商品加入购物车
   - 购物车管理: 查看、修改购物车内容

3. **权限限制测试** (应该被拒绝)
   - 普通用户不应该能够修改库存
   - 普通用户不应该能够查看低库存报告
   - 普通用户不应该能够管理商品

### 场景3：网络客户端权限测试

使用网络客户端直接发送命令测试权限：

1. **管理员登录测试**
   ```
   LOGIN admin 123456
   ```
   
2. **库存操作测试** (需要管理员权限)
   ```
   UPDATE_STOCK 1 10 add
   GET_LOW_STOCK_PRODUCTS 5
   ```

3. **普通用户登录测试**
   ```
   LOGIN testuser password
   ```

4. **权限拒绝测试** (应该返回权限不足)
   ```
   UPDATE_STOCK 1 10 add
   GET_LOW_STOCK_PRODUCTS 5
   ```

## 预期测试结果

### 管理员权限测试结果
- ✅ 管理员能够登录管理控制台
- ✅ 管理员能够查看和修改库存
- ✅ 管理员能够查看低库存报告
- ✅ 管理员能够管理商品信息

### 普通用户权限测试结果
- ✅ 普通用户能够登录购物界面
- ✅ 普通用户能够浏览商品和购物
- ❌ 普通用户尝试管理功能被拒绝
- ❌ 普通用户尝试库存操作被拒绝

### 权限错误信息
当普通用户尝试执行管理员功能时，应该收到：
```json
{
  "success": false,
  "message": "权限不足：只有管理员可以执行此操作",
  "error_code": 403
}
```

## 数据库表结构

### users 表
| 字段 | 类型 | 描述 |
|------|------|------|
| user_id | BIGINT | 用户ID (主键) |
| username | VARCHAR(50) | 用户名 |
| password | VARCHAR(255) | 密码 |
| phone | VARCHAR(15) | 手机号 |
| role | VARCHAR(20) | 用户角色 (admin/user/vip) |
| created_at | TIMESTAMP | 创建时间 |

## 故障排除

### 1. 权限检查失败
- 检查用户是否已登录
- 确认用户角色正确设置
- 验证会话管理是否正常工作

### 2. 管理员控制台无法启动
- 确保服务器已经启动
- 检查JNI库是否正确加载
- 验证数据库连接

### 3. 权限验证不生效
- 检查 `PermissionService.java` 是否正确导入
- 确认 `UserSession` 类中的角色信息
- 验证权限检查逻辑

## 开发进度

### 已完成功能 ✅
- [x] 用户会话管理
- [x] 角色权限验证
- [x] 管理员控制台界面
- [x] 用户购物界面
- [x] 库存管理权限控制
- [x] Maven 多执行配置

### 正在开发功能 🚧
- [ ] 商品管理功能完善
- [ ] 用户管理功能
- [ ] 报表和统计功能
- [ ] 订单管理权限细化

### 计划功能 📋
- [ ] 角色权限细粒度控制
- [ ] 操作日志记录
- [ ] 权限审计功能
- [ ] 多级管理员权限

## 技术实现细节

### 会话管理
- 使用 `UserSession` 类跟踪用户登录状态
- Channel 级别的会话存储
- 登录状态持久化

### 权限验证
- `PermissionService` 集中权限管理
- 基于角色的访问控制 (RBAC)
- 方法级别的权限检查

### 安全措施
- 登录状态验证
- 操作权限预检查
- 错误信息标准化
