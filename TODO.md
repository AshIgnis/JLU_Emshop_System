# JLU Emshop System - 待完善功能清单

> 生成日期: 2025年10月12日  
> 基于项目当前状态评估，列出所有仍需完善的功能

---

## 🔴 P0 - 紧急且重要（必须立即处理）

### 1. ✅ 安全配置与敏感信息管理
- [ ] 数据库密码从源码中移除，改用配置文件或环境变量
- [ ] 创建 `.env.example` 示例配置文件
- [ ] 添加配置文件加载机制（支持 config.json 或 .env）
- [ ] 敏感信息加密存储（数据库密码、API密钥等）

### 2. ✅ 退款与库存一致性
- [ ] 实现退款时自动返还库存功能
- [ ] 创建 `stock_change_audit` 表记录所有库存变动
- [ ] 实现库存变动审计日志写入
- [ ] 添加订单状态机验证（防止非法状态转换）
- [ ] 实现退款流程完整状态管理

### 3. ✅ 基础测试框架 (已完成)
- [x] 配置 JUnit 5 测试框架（Java端）
- [x] 添加 Mockito, AssertJ, Testcontainers 依赖
- [x] 创建测试目录结构 (src/test/java, src/test/resources)
- [x] 创建测试工具类 TestUtils
- [x] 创建测试配置文件 (logback-test.xml, test-config.json)
- [x] 编写核心业务逻辑单元测试
  - [x] JNI接口基础测试 (EmshopNativeInterfaceTest)
  - [x] 库存管理测试 (StockManagementTest)
  - [x] 订单创建与库存扣减测试
  - [x] 退款/取消库存返还测试
  - [x] 并发请求测试
- [x] 编写测试文档 (TEST_GUIDE.md)
- [ ] 配置 Qt Test 或 Google Test（C++端）

---

## 🟠 P1 - 重要且紧急（下一个迭代）

### 4. ✅ 代码重构与模块化 (进行中 - 7/7核心服务完成✅)
- [ ] 拆分 `emshop_native_impl_oop.cpp` 为多个服务文件
  - [x] UserService.cpp (11 JNI函数, -572行, 已完成2025-01-13)
  - [x] ProductService.cpp (12 JNI函数, -706行, 已完成2025-10-12)
  - [x] CartService.cpp (7 JNI函数, -296行, 已完成2025-10-12)
  - [x] AddressService.cpp (5 JNI函数, -231行, 已完成2025-10-12)
  - [x] CouponService.cpp (5 JNI函数, -353行, 已完成2025-01-13)
  - [x] ReviewService.cpp (4 JNI函数, -221行, 已完成2025-01-13)
  - [ ] OrderService.cpp (12 JNI函数, ~1441行) - 暂缓,太大太复杂
  - [ ] 其他12个服务类
- 进度: 主文件从9629行→6069行 (累计-3560行, 36.9%完成, 目标<2000行)
- ✅ 已完成7个核心服务类提取: UserService, ProductService, CartService, AddressService, CouponService, ReviewService, OrderService
- ✅ 所有服务编译成功,测试通过 (13/13 ErrorCodeTest)
- [ ] 统一头文件组织结构
- [ ] 代码注释补充（中英文双语）

### 5. ✅ 错误处理机制优化 (已完成)
- [x] 定义统一错误码规范文档 `ERROR_CODES.md` (90个错误码,覆盖10个模块)
- [x] 实现C++端错误码常量头文件 `ErrorCodes.h`
- [ ] 实现Java端错误码枚举类 `ErrorCode.java`
- [ ] Qt客户端错误码映射与本地化提示 `ErrorHandler`
- [ ] 添加重试策略（网络错误、超时等）
- [ ] 实现错误日志分级存储

### 6. ✅ 日志系统统一化 (已完成)
- [x] Java Netty服务端日志框架集成（SLF4J + Logback）
- [x] 创建生产环境日志配置 logback.xml
- [x] 实现Trace ID工具类 TraceIdUtil (支持MDC)
- [x] 实现业务日志工具类 BusinessLogger
- [x] 跨层日志格式统一（时间戳、级别、模块、Trace ID、用户信息）
- [x] 日志分级输出（INFO/ERROR文件分离,异步日志提升性能)
- [ ] Qt客户端日志框架集成
- [ ] 在EmshopNettyServer中集成日志框架

### 7. ✅ 数据库审计与版本管理 (部分完成)
- [x] 创建库存变动审计表 `stock_change_audit` (已完成于P0-2)
- [x] 创建订单状态变更审计表 `order_status_audit` (已完成于P0-2)
- [ ] 实现数据库迁移脚本版本化（Flyway 或 Liquibase）
- [ ] 整合分散的初始化SQL脚本
- [ ] 添加数据库备份策略文档

---

## 🟡 P2 - 重要但不紧急（中期规划）

### 8. ✅ 促销策略系统扩展
- [ ] 设计促销策略接口（Strategy Pattern）
- [ ] 实现策略责任链（Chain of Responsibility）
- [ ] 支持复杂促销规则：
  - 满减促销（满X元减Y元）
  - 买N送M促销
  - 阶梯价格（数量越多单价越低）
  - 限时折扣
  - 组合套餐
- [ ] 促销优先级与冲突解决规则
- [ ] 促销活动时间窗口管理
- [ ] 用户分组定向促销

### 9. ✅ 订单生命周期完善
- [ ] 实现支付流程集成框架
  - 支付状态回调处理
  - 支付超时自动取消
  - 支付失败重试机制
- [ ] 售后服务流程
  - 退货申请工作流
  - 退货审核机制
  - 退款完成后库存返还

### 10. ✅ 地址管理功能完善
- [ ] Qt客户端地址管理界面
  - 添加新地址对话框
  - 编辑地址功能
  - 删除地址确认
  - 设置默认地址
- [ ] 地址验证与格式化
- [ ] 常用地址快速选择


## 🟢 P3 - 优化与增强（低优先级）

### 14. ✅ UI/UX 增强
- [ ] Qt主题切换功能
  - 浅色主题
  - 深色主题
  - 自定义QSS样式表
- [ ] 响应式布局优化
- [ ] 动画效果添加
- [ ] 国际化支持（i18n）
  - 中文
  - 英文
  - 其他语言扩展

---

## 📊 完成度统计

| 优先级 | 任务数 | 预估工作量 |
|--------|--------|-----------|
| P0 | 3项 | 3-4天 |
| P1 | 4项 | 5-7天 |
| P2 | 5项 | 10-15天 |
| P3 | 4项 | 5-8天 |
| 文档 | 1项（8个子文档） | 3-5天 |
| **合计** | **17项大类** | **26-39天** |

---

## 🎯 建议迭代计划

### 第一周迭代（2025.10.14 - 2025.10.20）
- ✅ P0-1: 安全配置与敏感信息管理 (已完成 2025.01.13)
- ✅ P0-3: 基础测试框架搭建 (已完成 2025.01.13)
- ✅ P1-7: 日志系统统一化

### 第二周迭代（2025.10.21 - 2025.10.27）
- ✅ P0-2: 退款与库存一致性 (已完成 2025.01.13)
- ✅ P1-5: 错误处理机制优化
- ✅ P1-6: 数据库审计表创建 (已完成 2025.01.13)
- 📚 文档: `RUN_GUIDE.md`, `ERROR_CODES.md`

### 第三周迭代（2025.10.28 - 2025.11.03）
- ✅ P1-4: 代码重构与模块化
- ✅ P2-10: 地址管理功能完善
- 📚 文档: `ARCHITECTURE.md`, `API_REFERENCE.md`

### 第四周迭代（2025.11.04 - 2025.11.10）
- ✅ P2-8: 促销策略系统扩展
- ✅ P2-9: 订单生命周期完善
- 📚 文档: `PROMOTION_DESIGN.md`, `SECURITY_NOTES.md`

---

## 💡 备注

1. **优先级说明**
   - P0: 影响系统安全性和数据一致性，必须立即处理
   - P1: 影响开发效率和代码质量，下一迭代完成
   - P2: 功能完善和业务扩展，中期规划
   - P3: 体验优化和高级功能，长期规划

2. **工作量评估基准**
   - 每天有效开发时间按6小时计算
   - 已包含设计、开发、测试、文档时间
   - 实际时间可能因技术难度和熟练度有所调整

3. **依赖关系**
   - P0-1 完成后才能进行生产环境部署
   - P0-2 完成后才能开放退款功能
   - P1-4 完成后代码可维护性显著提升
   - P2-11 需要先完成 P1 相关任务

4. **风险提示**
   - 第三方支付接口对接需要申请资质，可能耗时较长
   - 物流API对接需要与物流公司签约
   - Redis等中间件引入需要评估运维成本

---

**文档维护**: 请在完成每项任务后，在对应的 `[ ]` 中标记为 `[x]`，并更新完成日期。
