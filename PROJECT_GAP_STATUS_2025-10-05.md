# JLU Emshop System 项目进度与差距分析 (截至 2025-10-05)

> 本文档基于当前代码仓库实际实现情况，对主 `readme.md` 中的规划内容进行对比，梳理已完成、部分完成与尚未实施的功能，并给出优先级建议与下一步行动计划。

---

## 1. 当前系统快照

| 维度 | 现状概要 |
|------|----------|
| 架构 | C/S 架构：Java Netty 服务端 + C++ JNI 业务核心 + Qt 桌面客户端 |
| 后端业务 | 用户 / 商品 / 购物车 / 订单 / 库存 / 优惠券（基础） |
| 库存策略 | 采用“订单创建时扣减”(Mode B) + 并发校验 + 事务包裹（最近新增） |
| 促销/优惠 | 简单优惠券（固定金额 / 百分比），无复杂组合规则/叠加策略引擎 |
| 并发控制 | 订单创建与库存扣减采用互斥 + 条件更新（WHERE stock >= need）+ 事务；无分布式锁 |
| 日志 | C++ 层统一 Logger（级别：DEBUG/INFO/WARN/ERROR）；Java / Qt 层无统一跨层日志聚合 |
| 客户端 | Qt 多 Tab：概览 / 商品 / 购物车 / 订单 / 管理员（库存低量、订单、促销） |
| UI 增强 | 购物车选择性结算、优惠预估、库存即时局部更新、优惠券详情提示、库存冲突高亮、低库存自动刷新/高亮 |
| 数据库 | MySQL；未见迁移脚本版本化 (Flyway/Liquibase)；初始化 SQL 存在但分散 |
| 安全 | 简单角色识别（admin / user），无 Token 过期策略、无加密传输、无权限粒度模型 |
| 测试 | 未发现自动化单元 / 集成 / 负载测试代码 |
| 部署 | 无 CI/CD 脚本 / 无容器化 / 无环境区分 (dev/prod) |
| 文档 | 主 README 偏规划性，JNI README 覆盖本地层实现；缺少“实际进度对照与运行指南一体化”文档 |

---

## 2. 已完成 (相对 README 原规划)

| 类别 | 已实现内容 |
|------|-------------|
| 用户功能 | 注册 / 登录 / 会话 Token（内存） / 基础角色识别 |
| 商品 | 列表 / 搜索（关键字+分页）/ 分类过滤 / 库存字段统一展示 |
| 购物车 | 添加 / 更新数量 / 选择性结算 (selected 标记) / 批量与单件快速下单 / 清空 / 移除 / 并发库存冲突提示 |
| 订单 | 创建（购物车/直接购买）/ 订单号生成 / 明细记录 / 地址快照 / 优惠券折扣 / 订单状态基础操作（管理入口修改） |
| 优惠券 | 基础使用：percentage / fixed；客户端优惠预估显示；下单结果回显折扣与最终金额 |
| 库存 | 订单创建时扣减；并发条件更新；低库存轮询 + 阈值可调；下单后客户端局部库存刷新（带剩余与扣减量） |
| 事务保障 | 订单创建（购物车/直接）与库存扣减包裹 BEGIN/COMMIT/ROLLBACK |
| 日志 | C++ Native 层分级日志 + 时间戳 + 输出到文件（emshop.log） |
| 客户端 UX | 零库存商品灰显 & 禁止加入；购物车优惠券详情提示；库存冲突高亮；下单成功状态消息显示 stock_changes；AdminTab 自动刷新 |
| 架构可演进点 | 独立 JNI 业务核心（未来可抽象成微服务或替换为纯 Java 服务） |

---

## 3. 部分完成 / 初级实现

| 模块 | 当前状态 | 差距 |
|------|----------|------|
| 促销 / 策略引擎 | 只有简单 coupon | 缺少复杂组合（满减+叠加规则）、生效范围、使用次数、优先级冲突解决 |
| 地址管理 | 有地址快照 | 缺少新增/编辑/删除的完善交互与默认地址管理 UI（部分逻辑存在） |
| 订单生命周期 | 状态字段存在 | 缺少支付流(SUCCESS/FAIL)、发货(物流号)、签收/售后全链路校验与时序约束 |
| 并发 / 竞态 | 基于互斥和条件更新 | 没有行级锁策略说明、无热点库存压测、无退单回滚库存流程（退款未返还库存） |
| 安全 | 简单角色字符串 | 无权限矩阵、无 Token 失效、无防重放、无传输层加密、无审计日志 |
| 错误处理 | JSON success/false | 缺失跨层错误码约定文档；客户端未分类重试 / 提示策略 |
| 配置 | 常量硬编码 | 缺少外部化配置（env/配置文件 + 安全凭据管理） |
| 日志统一 | C++ 有 | Java/Qt 未接入统一格式与追踪 ID；无上下文链路 ID |
| 部署 | 手工构建 | 无构建脚本整合（One-click build），无打包/版本号规范 |
| 文档 | 规划丰富 | 缺进度表、接口清单、测试计划、风险评估 |

---

## 4. 尚未实现（README 中提及但缺失）

| 类别 | README 提及 | 实际缺失点 |
|------|-------------|-------------|
| B/S 版本 | “完成后可使用 B/S” | 未创建任何 Web 前端或 Spring Boot 接口层（Java 代码非 Spring） |
| Python 分析 | 数据分析/日志处理 | 无 Python 目录与脚本 |
| Web 管理后台 | Spring Boot + REST API | 当前后台功能仅在 Qt AdminTab 内部实现 |
| 主题/多风格 UI | “风格不同 UI 选择” | 无主题切换 / QSS 皮肤机制 / Dark Mode |
| 售后服务 | 退货/售后流程 | 仅退款指令(基础)；缺少退货申请、审核、物流回执、库存返还策略 |
| 高级促销 | 混合策略/装饰/策略模式 | 未实现策略编排与多级折扣链路；无规则引擎（如表达式/脚本） |
| 并发与大促 | “双9.9 并发” | 无压测结果、无限流/降级/预库存缓存（如 Redis ）设计 |
| 异步通信 | “同步或异步通信” | 全部为同步请求响应；无事件总线或消息队列 |
| 系统监控 | 性能/健康监控 | 无 Metrics / Profiling / 自检接口 |
| CI/CD | 自动化 | 无流水线配置、无测试门禁 |
| 单元 / 集成测试 | 测试工具列出 | 无测试用例（C++, Java, Qt） |
| API 文档 | Swagger | 无接口清单 / 协议版本史 |
| 国际化 | 多语言支持 | 全部中文/部分英文硬编码，无翻译资源抽离 |
| 安全 | JWT/权限/加密 | 无 JWT、无密码策略、无敏感字段加密、无防 SQL 注入白名单（靠转义） |
| 配置管理 | application.yml | 当前参数硬编码（DB 密码直接出现在源码） |
| 数据迁移 | 版本演进 | 无迁移框架，只有初始化 SQL 脚本 |
| 性能优化 | 调优阶段 | 无基准测试报告；未提及慢查询分析 |
| 架构图同步 | README 图存在 | 图未更新以反映 JNI + Netty + Qt 实际结构 |
| 部署分层 | Dev/Prod 划分 | 无环境区分/无启动参数策略 |
| 运行指南 | 快速启动步骤 | README 缺“一键运行”或最少命令序列 |
| 风险管理 | 生命周期 | 无风险清单与应对措施 |

---

## 5. 风险与技术债清单

| 风险/债务 | 影响 | 建议缓解 |
|-----------|------|----------|
| 数据库账户密码硬编码 | 安全合规风险 | 外部配置 + 环境变量注入 |
| 缺乏测试 | 功能回归成本高 | 引入最小集单元 / 集成测试基线 |
| 退款不返库存 | 库存失真 | 退款工作流内补库存逻辑（状态机驱动） |
| 没有库存快照审计 | 追责困难 | 增加 stock_change_audit 表（order_id, product_id, delta, before, after, ts, cause） |
| 并发互斥粒度过粗 | 性能瓶颈 | 每商品行级乐观锁（UPDATE ... WHERE id=? AND version=?） |
| 缺少错误码规范 | 前端难分类处理 | 制定统一错误码与语义表 + 客户端分类提示 |
| 未区分开发 / 生产日志级别 | 噪音/性能 | 配置化日志级别，支持按模块动态调整 |
| 单文件过大 (JNI ~400KB 源) | 可维护性下降 | 拆分按服务文件：UserService.cpp / ProductService.cpp / OrderService.cpp 等 |
| 促销与优惠耦合订单创建 | 扩展困难 | 引入策略链 (Chain of Responsibility) + 配置驱动 |

---

## 6. 推荐优先级 (Impact / Effort 粗略评估)

| 任务 | 影响 | 预估工作量 | 优先级 |
|------|------|------------|--------|
| 提取配置与敏感信息脱敏 | 高 | 0.5~1d | P0 |
| 退款 → 库存返还 / 审计表 | 高 | 1~2d | P0 |
| 最小化单元测试基线（库存+订单） | 高 | 1~2d | P0 |
| 拆分 JNI 大文件 | 中高 | 2~3d | P1 |
| 错误码及客户端映射 | 中 | 1d | P1 |
| Stock change audit 表 + 接口 | 中 | 1d | P1 |
| 优惠策略抽象(接口+简单链) | 中 | 2d | P2 |
| AdminTab 库存推送(服务端主动广播) | 中 | 2d | P2 |
| 主题/样式切换（QSS 两套） | 低 | 1d | P3 |
| Web API 初始骨架 (Spring Boot) | 高(战略) | 5~7d | P2 |
| CI 简单流水线 (构建+单测) | 高 | 1~2d | P1 |
| 退款/售后全生命周期扩展 | 高 | 3~5d | P2 |

> 说明：P0 = 本阶段必须，P1 = 下一批次，P2 = 中期规划，P3 = 低优先级增强。

---

## 7. 下一个 1~2 周迭代建议 (Sprint Proposal)

| Day | 建议目标 |
|-----|----------|
| 1 | 抽离配置（DB/端口/日志级别），添加 `.env.example` 或 `config.json` 外部文件 |
| 2 | 引入最小测试框架（选择 Java JUnit + C++ 可选 GoogleTest；先对订单/库存逻辑做 3~5 个核心用例） |
| 3 | 退款逻辑：新增库存回补 + 状态机（pending→paid→shipped→delivered→refunded）约束校验 |
| 4 | 添加 `stock_change_audit` 表与记录写入；AdminTab 增加“库存操作审计”页（可后置） |
| 5 | JNI 拆分类（UserService.cpp / ProductService.cpp / OrderService.cpp / CartService.cpp / Common / Logger）初步迁移一部分 |
| 6 | 定义 `ERROR_CODE` 语义表并在 README 中补充；Qt 客户端按错误码展示本地化消息 |
| 7 | 促销策略接口定义（IStrategy / Chain）与最基础实现（固定金额 / 百分比封装） |

---

## 8. 建议结构化补文档条目

新增或完善文档：

- `RUN_GUIDE.md`: 本地运行步骤（数据库初始化 → 构建 JNI → 启动 Java 服务 → 启动 Qt 客户端）
- `ARCHITECTURE.md`: 实际分层图 (Client Qt / Netty Server / JNI / MySQL) + 关键数据流 + 时序图（下单 / 扣库存 / 退款）
- `ERROR_CODES.md`: 错误码 → 描述 → 建议处理方式
- `PROMOTION_DESIGN.md`: 优惠策略扩展计划
- `SECURITY_NOTES.md`: 未来安全基线（认证 / 授权 / 审计 / 防注入 / 加密）
- `TEST_PLAN.md`: 覆盖范围、关键用例、性能指标

---

## 9. 差异摘要 (TL;DR)

- README 中的“多端 / Web / Python / 高级促销 / 售后全链路 / 测试 / 安全配置”等大部分仍是规划性描述，尚未落地。
- 核心交易闭环（商品→购物车→下单→折扣→库存扣减）已经建立，并新增事务与库存变动即时回显，构成 MVP。
- 现在的最紧急改进方向：安全合规（配置脱敏）、数据一致性（退款返库）、质量保障（测试基线）。

---

## 10. 附：可直接添加的审计表示例 (建议后续实施)

```sql
CREATE TABLE stock_change_audit (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_id BIGINT NOT NULL,
  order_id BIGINT NULL,
  change_type VARCHAR(32) NOT NULL, -- order_deduct / refund_restore / manual_adjust
  delta INT NOT NULL,
  stock_before INT NOT NULL,
  stock_after INT NOT NULL,
  operator VARCHAR(64) DEFAULT 'system',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_sca_product ON stock_change_audit(product_id);
```

---

## 11. 结语

该分析文件旨在帮助后续迭代聚焦“高影响、低延迟”事项，形成内循环（配置→测试→一致性→扩展）。如需，我可以继续自动生成上述建议文档的初稿，或直接开始实现 P0/P1 项。

> 需要我：a) 生成运行指南，b) 拆分 JNI，c) 加入库存审计 —— 任选其一告诉我即可继续。
